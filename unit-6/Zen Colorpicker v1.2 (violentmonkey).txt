// ==UserScript==
// @name         Zen Color Picker v1.2
// @namespace    ZenMods
// @version      v1.2
// @description  very cool custom color picker for zen (and possibly other browsers but I haven't tested)
// @author       AJ
// @match        *://*/*
// @grant        GM_addStyle
// @grant        GM_getResourceText
// @require      https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js
// @require      https://html2canvas.hertzen.com/dist/html2canvas.min.js
// @resource     PICKR_CSS https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    if (typeof Pickr === 'undefined') return;

    // Load Classic CSS
    const css = GM_getResourceText("PICKR_CSS");
    if (css) GM_addStyle(css);

    GM_addStyle(`
        /* --- MAIN WINDOW --- */
        .pcr-app {
            background: rgba(30, 30, 35, 0.75) !important;
            backdrop-filter: blur(25px) saturate(180%) !important;
            -webkit-backdrop-filter: blur(25px) saturate(180%) !important;
            border: 1px solid rgba(255, 255, 255, 0.12) !important;
            border-radius: 18px !important;
            box-shadow: 0 40px 80px rgba(0,0,0,0.6), inset 0 0 0 1px rgba(255,255,255,0.05) !important;
            width: 24em !important;
            min-height: 22em !important;
            z-index: 2147483647 !important;
            padding-top: 0 !important;
            padding-bottom: 15px !important;
            display: flex !important;
            flex-direction: column !important;
            font-family: system-ui, -apple-system, sans-serif !important;
        }

        .pcr-palette { border-radius: 8px !important; }
        .pcr-palette::before { border-radius: 8px !important; }
        .pcr-app[data-theme=classic] .pcr-selection .pcr-color-palette { height: 15em !important; }

        /* --- DRAG HANDLE --- */
        .zen-drag-handle {
            width: 100%; height: 14px;
            background: transparent; cursor: grab;
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 0px !important; flex-shrink: 0;
        }
        .zen-drag-handle:active { cursor: grabbing; }
        .zen-drag-handle::after {
            content: ''; width: 40px; height: 4px;
            background: rgba(255,255,255,0.2); border-radius: 2px;
        }

        /* --- INTERACTION BOX --- */
        .pcr-interaction {
            display: flex !important;
            flex-direction: column !important;
            gap: 12px !important;
            padding: 10px 6px 0px 0px !important;
            height: auto !important;
        }

        /* --- LAYOUT DIVS --- */
        .zen-row-top { display: flex !important; width: 100% !important; gap: 8px !important; align-items: center !important; }
        .zen-row-bottom { display: flex !important; width: 100% !important; justify-content: space-between !important; align-items: center !important; }
        .zen-group-left { display: flex !important; gap: 4px !important; }
        .zen-group-right { display: flex !important; gap: 8px !important; }

        /* --- WIDGET STYLING --- */
        .pcr-interaction .pcr-result {
            order: 0 !important; flex-grow: 1 !important; width: auto !important;
            background: rgba(0, 0, 0, 0.3) !important; border: none !important;
            border-radius: 8px !important; color: #fff !important;
            height: 36px !important; text-align: center !important;
            font-family: 'Segoe UI Variable', monospace !important; font-size: 0.85em !important;
            margin: 0 !important; float: none !important; box-shadow: none !important;
        }
        .pcr-interaction .pcr-result:focus {
            background: rgba(0, 0, 0, 0.5) !important; outline: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        .zen-eyedropper-btn {
            width: 36px !important; height: 36px !important; flex-shrink: 0 !important;
            border-radius: 8px !important; background: rgba(80, 200, 255, 0.2) !important;
            color: #ccf0ff !important; border: none !important;
            display: flex !important; justify-content: center !important; align-items: center !important;
            cursor: pointer !important; transition: background 0.2s !important;
        }
        .zen-eyedropper-btn:hover { background: rgba(80, 200, 255, 0.4) !important; color: white !important; }

        .pcr-interaction .pcr-type {
            background: rgba(255, 255, 255, 0.06) !important; border: none !important;
            color: rgba(255,255,255,0.7) !important; border-radius: 6px !important;
            padding: 0 10px !important; height: 30px !important; font-size: 0.75em !important;
            font-weight: 600 !important; margin: 0 !important; float: none !important;
            font-family: system-ui, sans-serif !important; box-shadow: none !important;
        }
        .pcr-interaction .pcr-type:hover, .pcr-interaction .pcr-type.active {
            background: rgba(255, 255, 255, 0.2) !important; color: #fff !important;
        }

        .pcr-interaction .pcr-save, .pcr-interaction .pcr-cancel {
            height: 30px !important; border-radius: 6px !important; font-weight: 600 !important;
            cursor: pointer !important; display: flex !important; justify-content: center !important; align-items: center !important;
            margin: 0 !important; float: none !important; font-family: system-ui, sans-serif !important;
            border: none !important; box-shadow: none !important;
        }
        .pcr-interaction .pcr-cancel { background: rgba(255, 80, 80, 0.25) !important; color: #ffcccc !important; padding: 0 12px !important; }
        .pcr-interaction .pcr-cancel:hover { background: rgba(255, 80, 80, 0.5) !important; color: white !important; }
        .pcr-interaction .pcr-save { background: rgba(255, 255, 255, 0.9) !important; color: #000 !important; padding: 0 16px !important; }
        .pcr-interaction .pcr-save:hover { background: #fff !important; }
        .pcr-clear { display: none !important; }

        /* --- TRIGGER BUTTON --- */
        .zen-trigger-default {
            appearance: none !important; width: 44px !important; height: 44px !important;
            border-radius: 14px !important; border: 1px solid rgba(255, 255, 255, 0.2) !important;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1), 0 2px 5px rgba(0,0,0,0.2) !important;
            background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 16 16" version="1.1"%3E%3Cpath fill="%23ffffff" d="M15 1c-1.8-1.8-3.7-0.7-4.6 0.1-0.4 0.4-0.7 0.9-0.7 1.5v0c0 1.1-1.1 1.8-2.1 1.5l-0.1-0.1-0.7 0.8 0.7 0.7-6 6-0.8 2.3-0.7 0.7 1.5 1.5 0.8-0.8 2.3-0.8 6-6 0.7 0.7 0.7-0.6-0.1-0.2c-0.3-1 0.4-2.1 1.5-2.1v0c0.6 0 1.1-0.2 1.4-0.6 0.9-0.9 2-2.8 0.2-4.6zM3.9 13.6l-2 0.7-0.2 0.1 0.1-0.2 0.7-2 5.8-5.8 1.5 1.5-5.9 5.7z"/%3E%3C/svg%3E') !important;
            background-repeat: no-repeat !important; background-position: center !important; background-size: 20px !important;
            transition: transform 0.2s; cursor: pointer !important;
            border: none;
        }
        .zen-trigger-default:hover { transform: scale(1.1) translateY(-2px) !important; }
        .zen-icon-black {
            background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 16 16" version="1.1"%3E%3Cpath fill="%23000000" d="M15 1c-1.8-1.8-3.7-0.7-4.6 0.1-0.4 0.4-0.7 0.9-0.7 1.5v0c0 1.1-1.1 1.8-2.1 1.5l-0.1-0.1-0.7 0.8 0.7 0.7-6 6-0.8 2.3-0.7 0.7 1.5 1.5 0.8-0.8 2.3-0.8 6-6 0.7 0.7 0.7-0.6-0.1-0.2c-0.3-1 0.4-2.1 1.5-2.1v0c0.6 0 1.1-0.2 1.4-0.6 0.9-0.9 2-2.8 0.2-4.6zM3.9 13.6l-2 0.7-0.2 0.1 0.1-0.2 0.7-2 5.8-5.8 1.5 1.5-5.9 5.7z"/%3E%3C/svg%3E') !important;

        }
        .zen-text-hide { color: transparent !important; }

        /* --- MAGNIFIER OVERLAY (Centered) --- */
        #zen-magnifier-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 2147483647;
            cursor: none !important; /* HIDE MOUSE */
            background: transparent;
        }
        #zen-magnifier-lens {
            position: fixed; pointer-events: none;
            width: 150px; height: 150px;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 8px; /* Square with slight roundness */
            overflow: hidden;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.5), 0 10px 25px rgba(0,0,0,0.5);
            background: #000;
            z-index: 2147483648;
            /* CENTER LENS ON CURSOR */
            transform: translate(-50%, -50%);
        }
        #zen-magnifier-canvas {
            width: 100%; height: 100%;
            image-rendering: pixelated; /* Sharp pixels */
        }
        #zen-magnifier-grid {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            /* 10px Grid matches 10x Zoom exactly */
            background-image:
                linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 10px 10px;
        }
        #zen-magnifier-selector {
            position: absolute;
            top: 50%; left: 50%;
            width: 10px; height: 10px; /* One Grid Cell */
            border: 1px solid rgba(255, 50, 50, 1); /* Bright Red */
            box-sizing: border-box;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 0 1px rgba(0,0,0,0.5); /* Outer shadow for contrast */
        }
        #zen-magnifier-text {
            position: absolute; bottom: 0; width: 100%;
            background: rgba(0,0,0,0.7);
            color: #fff; font-size: 11px; font-family: monospace;
            text-align: center; padding: 3px 0;
        }
    `);

    // --- MAGNIFIER LOGIC ---
    function startMagnifier(pickrInstance) {
        document.body.style.cursor = 'wait';

        html2canvas(document.body, {
            useCORS: true, logging: false, scale: 1,
            x: window.scrollX, y: window.scrollY,
            width: window.innerWidth, height: window.innerHeight
        }).then(pageCanvas => {
            const overlay = document.createElement('div'); overlay.id = 'zen-magnifier-overlay';
            const lens = document.createElement('div'); lens.id = 'zen-magnifier-lens';

            const canvas = document.createElement('canvas');
            canvas.id = 'zen-magnifier-canvas';
            // 150px / 10zoom = 15 pixels. ODD NUMBER = Perfect Center.
            canvas.width = 150; canvas.height = 150;
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = false;

            const grid = document.createElement('div'); grid.id = 'zen-magnifier-grid';
            const selector = document.createElement('div'); selector.id = 'zen-magnifier-selector';
            const text = document.createElement('div'); text.id = 'zen-magnifier-text';

            lens.append(canvas, grid, selector, text);
            overlay.append(lens);
            document.body.append(overlay);

            const ZOOM = 10;
            const pixelCtx = pageCanvas.getContext('2d');

            const updateLens = (e) => {
                const x = e.clientX;
                const y = e.clientY;

                lens.style.left = x + 'px';
                lens.style.top = y + 'px';

                // CENTERED MATH (15px source width)
                // Half of 15 is 7.5. Floor is 7.
                // So we want x - 7 to x + 7.
                const offset = 7;

                const srcX = x + window.scrollX - offset;
                const srcY = y + window.scrollY - offset;

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(pageCanvas, srcX, srcY, 15, 15, 0, 0, 150, 150);

                // Sample exact center pixel
                const p = pixelCtx.getImageData(x + window.scrollX, y + window.scrollY, 1, 1).data;
                const hex = '#' + ((1 << 24) + (p[0] << 16) + (p[1] << 8) + p[2]).toString(16).slice(1).toUpperCase();
                text.innerText = hex;
            };

            const pickColor = (e) => {
                const x = e.clientX;
                const y = e.clientY;
                const p = pixelCtx.getImageData(x + window.scrollX, y + window.scrollY, 1, 1).data;
                const hex = '#' + ((1 << 24) + (p[0] << 16) + (p[1] << 8) + p[2]).toString(16).slice(1);

                pickrInstance.setColor(hex);

                overlay.remove();
                document.removeEventListener('mousemove', updateLens);
            };

            overlay.addEventListener('click', pickColor);
            document.addEventListener('mousemove', updateLens);
            document.body.style.cursor = 'default'; // Cursor handled by overlay CSS now

        }).catch(err => {
            document.body.style.cursor = 'default';
            alert("Magnifier failed. Page too large?");
        });
    }

    // --- DRAG LOGIC ---
    function makeDraggable(el, handle) {
        let isDragging = false, startX, startY, initialLeft, initialTop;
        handle.addEventListener('mousedown', (e) => {
            isDragging = true; startX = e.clientX; startY = e.clientY;
            const rect = el.getBoundingClientRect();
            initialLeft = rect.left; initialTop = rect.top;
            el.style.position = 'fixed'; el.style.left = `${initialLeft}px`; el.style.top = `${initialTop}px`;
            el.style.transform = 'none'; document.body.style.userSelect = 'none';
        });
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            el.style.left = `${initialLeft + (e.clientX - startX)}px`;
            el.style.top = `${initialTop + (e.clientY - startY)}px`;
        });
        document.addEventListener('mouseup', () => { isDragging = false; document.body.style.userSelect = ''; });
    }

    function checkContrast(colorInput, inputEl) {
        let r=0, g=0, b=0, a=1;
        if (colorInput && typeof colorInput.toRGBA === 'function') {
            const rgba = colorInput.toRGBA(); r=rgba[0]; g=rgba[1]; b=rgba[2]; a=rgba[3];
        } else if (typeof colorInput === 'string' && colorInput.startsWith('#')) {
            const hex = colorInput.replace('#', '');
            if (hex.length >= 6) {
                r = parseInt(hex.substring(0,2),16); g = parseInt(hex.substring(2,4),16); b = parseInt(hex.substring(4,6),16);
                if (hex.length === 8) a = parseInt(hex.substring(6,8),16)/255;
            }
        }
        const brightness = Math.round(((r * 299) + (g * 587) + (b * 114)) / 1000);
        if (brightness > 140 || a < 0.38) inputEl.classList.add('zen-icon-black');
        else inputEl.classList.remove('zen-icon-black');
    }

    // --- INIT ---
    function initColorPicker(input) {
        if (input.dataset.zenReady) return;
        input.dataset.zenReady = "true";

        let originalColor = input.value || '#000000';
        input.setAttribute('type', 'text');
        input.classList.add('zen-text-hide');
        input.classList.add('zen-trigger-default');
        input.style.backgroundColor = originalColor;
        checkContrast(originalColor, input);

        const pickr = Pickr.create({
            el: input,
            theme: 'classic',
            default: originalColor,
            useAsButton: true,
            padding: 8,
            components: {
                preview: true, opacity: true, hue: true,
                interaction: { hex: true, rgba: true, hsla: true, input: true, cancel: true, save: true }
            },
            i18n: { 'btn:save': 'Apply', 'btn:cancel': 'Cancel' }
        });

        pickr.on('init', (instance) => {
            const app = instance._root.app;
            const handle = document.createElement('div');
            handle.className = 'zen-drag-handle';
            app.prepend(handle);
            makeDraggable(app, handle);

            setTimeout(() => {
                const interactionBox = instance._root.interaction.result.parentNode;

                const rowTop = document.createElement('div'); rowTop.className = 'zen-row-top';
                const rowBottom = document.createElement('div'); rowBottom.className = 'zen-row-bottom';
                const groupLeft = document.createElement('div'); groupLeft.className = 'zen-group-left';
                const groupRight = document.createElement('div'); groupRight.className = 'zen-group-right';

                const eyeBtn = document.createElement('div');
                eyeBtn.className = 'zen-eyedropper-btn';
                eyeBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 16 16"><path fill="currentColor" d="M15 1c-1.8-1.8-3.7-0.7-4.6 0.1-0.4 0.4-0.7 0.9-0.7 1.5v0c0 1.1-1.1 1.8-2.1 1.5l-0.1-0.1-0.7 0.8 0.7 0.7-6 6-0.8 2.3-0.7 0.7 1.5 1.5 0.8-0.8 2.3-0.8 6-6 0.7 0.7 0.7-0.6-0.1-0.2c-0.3-1 0.4-2.1 1.5-2.1v0c0.6 0 1.1-0.2 1.4-0.6 0.9-0.9 2-2.8 0.2-4.6zM3.9 13.6l-2 0.7-0.2 0.1 0.1-0.2 0.7-2 5.8-5.8 1.5 1.5-5.9 5.7z"/></svg>`;

                eyeBtn.addEventListener('click', () => {
                    if (window.EyeDropper) {
                        new EyeDropper().open().then(r => {
                            pickr.setColor(r.sRGBHex);
                        }).catch(()=>{});
                    } else {
                        startMagnifier(pickr);
                    }
                });

                rowTop.appendChild(instance._root.interaction.result);
                rowTop.appendChild(eyeBtn);

                instance._root.interaction.options.forEach(btn => groupLeft.appendChild(btn));

                groupRight.appendChild(instance._root.interaction.cancel);
                groupRight.appendChild(instance._root.interaction.save);

                rowBottom.appendChild(groupLeft);
                rowBottom.appendChild(groupRight);

                interactionBox.appendChild(rowTop);
                interactionBox.appendChild(rowBottom);

                const cleanValue = () => {
                    const val = instance._root.interaction.result.value;
                    if (val.startsWith('rgba(')) instance._root.interaction.result.value = val.replace('rgba(', '').replace(')', '');
                    else if (val.startsWith('hsla(')) instance._root.interaction.result.value = val.replace('hsla(', '').replace(')', '');
                };
                pickr.on('change', () => setTimeout(cleanValue, 0));
                instance._root.interaction.options.forEach(btn => btn.addEventListener('click', () => setTimeout(cleanValue, 0)));
                instance._root.interaction.result.addEventListener('change', (e) => {
                    const raw = e.target.value.trim();
                    if (/^[0-9\.,\s%]+$/.test(raw)) {
                         if (!pickr.setColor(`rgba(${raw})`)) pickr.setColor(`hsla(${raw})`);
                    }
                });
            }, 10);
        });

        pickr.on('change', (color) => {
            const hex = color.toHEXA().toString();
            input.style.backgroundColor = hex;
            checkContrast(color, input);
            input.value = (color.a < 1) ? hex : hex.substring(0, 7);
            input.dispatchEvent(new Event('input', { bubbles: true }));
            input.dispatchEvent(new Event('change', { bubbles: true }));
        });

        pickr.on('cancel', () => {
            input.style.backgroundColor = originalColor;
            input.value = originalColor;
            checkContrast(originalColor, input);
            input.dispatchEvent(new Event('input', { bubbles: true }));
            input.dispatchEvent(new Event('change', { bubbles: true }));
            pickr.hide();
        });

        pickr.on('save', (color) => {
            originalColor = color.toHEXA().toString();
            pickr.hide();
        });
    }

    const observer = new MutationObserver((mutations) => {
        mutations.forEach((m) => {
            m.addedNodes.forEach((node) => {
                if (node.nodeType === 1) {
                    if (node.tagName === 'INPUT' && node.getAttribute('type') === 'color') initColorPicker(node);
                    node.querySelectorAll?.('input[type="color"]').forEach(initColorPicker);
                }
            });
        });
    });

    if (document.body) {
        observer.observe(document.body, { childList: true, subtree: true });
        document.querySelectorAll('input[type="color"]').forEach(initColorPicker);
    }
})();