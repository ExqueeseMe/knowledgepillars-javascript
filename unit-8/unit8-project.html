<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Lesson 8 Project</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.10/css/weather-icons.min.css">
    <link rel="stylesheet" href="./project8-style.css">
</head>
<body>
<div id="main-card">
    <h1>Weather Forecast</h1>
    <p>This web app shows basic weather information for the city of your choice.</p>

    <label for="city-dropdown">Choose your city:</label>
    <div id="search">
        <input id="city-dropdown" list="city-list" autocomplete="off">
        <datalist id="city-list"></datalist>
        <button id="search-btn">Submit</button>
    </div>
</div>
    <div id="weather-output" class="hidden"></div>

<script>
    const searchBtn = document.getElementById('search-btn');
    const inputField = document.getElementById('city-dropdown');
    const dataList = document.getElementById('city-list');
    const weatherOutput = document.getElementById('weather-output');

    function getWeatherDescription(code) {
        const codes = {
            0: "Clear sky",
            1: "Mainly clear", 2: "Partly cloudy", 3: "Overcast",
            45: "Fog", 48: "Depositing rime fog",
            51: "Light Drizzle", 53: "Moderate Drizzle", 55: "Dense Drizzle",
            56: "Light Freezing Drizzle", 57: "Dense Freezing Drizzle",
            61: "Slight Rain", 63: "Moderate Rain", 65: "Heavy Rain",
            66: "Light Freezing Rain", 67: "Heavy Freezing Rain",
            71: "Slight Snow", 73: "Moderate Snow", 75: "Heavy Snow",
            77: "Snow grains",
            80: "Slight Rain Showers", 81: "Moderate Rain Showers", 82: "Violent Rain Showers",
            85: "Slight Snow Showers", 86: "Heavy Snow Showers",
            95: "Thunderstorm", 96: "Thunderstorm with slight hail", 99: "Thunderstorm with heavy hail"
        };
        return codes[code] || "Unknown";
    }

    function getWeatherIcon(code) {
        const icons = {
            0: "wi wi-day-sunny",           // Clear sky
            1: "wi wi-day-sunny-overcast",  // Mainly clear
            2: "wi wi-day-cloudy",          // Partly cloudy
            3: "wi wi-cloudy",              // Overcast
            45: "wi wi-fog",                // Fog
            48: "wi wi-fog",                // Depositing rime fog
            51: "wi wi-sprinkle",           // Light Drizzle
            53: "wi wi-sprinkle",           // Moderate Drizzle
            55: "wi wi-sprinkle",           // Dense Drizzle
            56: "wi wi-sleet",              // Light Freezing Drizzle
            57: "wi wi-sleet",              // Dense Freezing Drizzle
            61: "wi wi-showers",            // Slight Rain
            63: "wi wi-rain",               // Moderate Rain
            65: "wi wi-rain-wind",          // Heavy Rain
            66: "wi wi-sleet",              // Light Freezing Rain
            67: "wi wi-rain-mix",           // Heavy Freezing Rain
            71: "wi wi-snow",               // Slight Snow
            73: "wi wi-snow-wind",          // Moderate Snow
            75: "wi wi-snow-wind",          // Heavy Snow
            77: "wi wi-snow",               // Snow grains
            80: "wi wi-showers",            // Slight Rain Showers
            81: "wi wi-rain",               // Moderate Rain Showers
            82: "wi wi-rain-wind",          // Violent Rain Showers
            85: "wi wi-snow",               // Slight Snow Showers
            86: "wi wi-snow-wind",          // Heavy Snow Showers
            95: "wi wi-thunderstorm",       // Thunderstorm
            96: "wi wi-night-snow-thunderstorm",      // Thunderstorm with slight hail
            99: "wi wi-night-snow-thunderstorm"       // Thunderstorm with heavy hail
        };
        return icons[code] || "wi wi-na";
    }

    inputField.addEventListener('input', function(event) {
        const currentValue = event.target.value;
        const apiURL = `https://geocoding-api.open-meteo.com/v1/search?name=${currentValue}&count=10&language=en&format=json`;

        fetch(apiURL)
            .then(response => response.json())
            .then(data => {
                dataList.innerHTML = '';

                if (data.results) {
                    const seenCities = new Set();

                    data.results.forEach(city => {
                        const cityString = `${city.name}, ${city.country}`;

                        if (seenCities.has(cityString)) {
                            return;
                        }

                        seenCities.add(cityString);

                        const option = document.createElement('option');

                        option.value = `${city.name}, ${city.country}`;

                        option.setAttribute('data-lat', city.latitude);
                        option.setAttribute('data-lon', city.longitude);

                        dataList.appendChild(option);
                    });
                }
            });
    });

    searchBtn.addEventListener('click', function() {
        const selectedValue = inputField.value;
        const options = document.getElementById('city-list').options;

        for (let i = 0; i < options.length; i++) {
            if (options[i].value === selectedValue) {
                const lat = options[i].getAttribute('data-lat');
                const lon = options[i].getAttribute('data-lon');

                getWeather(lat, lon, selectedValue);
                return;
            }
        }

        alert("Please select a valid city from the dropdown list.");
    });

    function getWeather(lat, lon, cityName) {
        const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max&temperature_unit=fahrenheit&timezone=auto`;
        fetch(weatherUrl)
            .then(response => response.json())
            .then(weatherData => {
                const current = weatherData.current_weather;
                const daily = weatherData.daily;

                const temp = current.temperature;
                const high = daily.temperature_2m_max[0];
                const low = daily.temperature_2m_min[0];
                const precipProb = daily.precipitation_probability_max[0];

                const description = getWeatherDescription(current.weathercode);

                const iconClass = getWeatherIcon(current.weathercode);

                weatherOutput.innerHTML = `
                <h3>Weather in ${cityName}</h3>
                <p><strong>Current Temp:</strong> ${temp}°F</p>
                <p><strong>Condition:</strong> <i class="${iconClass}"></i> ${description}</p>
                <p><strong>Chance of Precip:</strong> ${precipProb}%</p>
                <p><strong>High:</strong> ${high}°F | <strong>Low:</strong> ${low}°F</p>
            `;
                weatherOutput.classList.remove('hidden');
            })
            .catch(error => {
                console.error('Error fetching weather:', error);
            });
    }

</script>

</body>
</html>